{% extends 'main-game.html' %}

{% block content %}

<h2>Room</h2>

<p id="app"></p>

<script>
  let loc = window.location;
  let wstart = 'ws://'
  if (loc.protocol === 'https:') {
    wstart = "wss://"
  }
  let endpoint = wstart + loc.host + loc.pathname
  let socket = new WebSocket(endpoint);
  let me = "{{user.username}}"
  let gameRoomAdmin = "{{game_room.admin.username}}"


  const open_socket = new Promise(resolve => {
    socket.addEventListener("open", (e) => {
      resolve({"open_socket_state": socket.readyState});
    });
  });


  Promise.all([open_socket]).then(result => {
    console.log("open");
    let data = {
      "status": "user_new",
      "message": "New user entered the room.",
      "data": {
        "new_user_username": "{{ user.username }}",
        "unique_peer_id": result[0].unique_peer_id,
        "game_room_unique_id": "{{ game_room.unique_game_id }}"
      }
    };
    let response = {"type": "user.new", "text": data};
    socket.send(JSON.stringify(response));

  });

  app = document.getElementById('app');

  socket.onmessage = function (event) {
    var data = JSON.parse(event.data);
    var array_players = JSON.parse(data['gameData'])['players'];
    if (data['status'] == "user_new") {
      while (app.firstChild) {
        app.firstChild.remove()
      }
      for (const player of array_players) {
        div = document.createElement('p')
        div.innerHTML = player;
        app.append(div);
      }

    } else if (data['status'] == "user_left_room") {
      while (app.firstChild) {
        app.firstChild.remove()
      }
      for (const player of array_players) {
        div = document.createElement('p')
        div.innerHTML = player;
        app.append(div);
      }

    }

  }

</script>

{% endblock %}
